<!doctype html>
<html lang="en">
<head>
  <title>Payment Request Interactive Demo</title>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href='//fonts.googleapis.com/css?family=Raleway:400,300,600' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="libs/skeleton/css/normalize.css">
  <link rel="stylesheet" href="libs/skeleton/css/skeleton.css">

  <script src="libs/jquery/dist/jquery.min.js"></script>
  <style>
  .section {
    margin: 2rem 0;
  }

  .doublebutton {
    width: 158px;
    display: inline-block;
    text-align: center;
  }
  #paybutton {
    display: block;
    width: 160px;
    line-height: 60px;
    height: 60px;
    font-size: 24px;
    margin: 10px auto;
  }

@media (max-width:550px) {
  #orders .eight {
      width: 130px;
    }
  #orders .three {
      width: 90px;
    }
  #orders .one {
      width: 100px;
    }
  #orders input {
    width: 90%;
  }
}
</style>

</head>
<body>
  <div class="section">
    <div class="container">
      <div class="row">
        <div class="twelve columns">
          <h2>Payment Request API</h2>
        </div>
      </div>
    </div>
  </div>

  <div class="section">
    <div class="container">
      <div class="row">
        <div class="twelve columns" id="instruments">
          <h4>Payment Methods</h4>
          <div class="doublebutton"><button class="button-primary">mastercard</button></div>
          <div class="doublebutton"><button>discover</button></div>
          <div class="doublebutton"><button>unionpay</button></div>
          <div class="doublebutton"><button>maestro</button></div>
          <div class="doublebutton"><button>diners</button></div>
          <div class="doublebutton"><button>amex</button></div>
          <div class="doublebutton"><button class="button-primary">visa</button></div>
          <div class="doublebutton"><button>jcb</button></div>
          <div class="doublebutton"><button>mir</button></div>
        </div>
      </div>
    </div>
  </div>

  <div class="section" id="orders">
    <div class="container">
      <div class="row">
        <div class="twelve columns">
          <h4>Total Item</h4>
        </div>
      </div>
      <div class="row">
        <div class="seven columns">
              <label for="total_label">Label</label>
        </div>
        <div class="three columns">
              <label for="total_value">Amount</label>
        </div>
        <div class="two columns">
              <label for="total_currency">Currency</label>
        </div>
      </div>
      <span id="total_item">
        <div id="display-item" class="row">
          <div class="seven columns">
              <input class="u-full-width" type="text" placeholder="Item Label" id="label" value="Total">
          </div>
          <div class="three columns">
              <input class="u-full-width" type="number" placeholder="32.00" id="value" value="32.00">
          </div>
          <div class="two columns">
              <input class="u-full-width" type="text" placeholder="USD" id="currency" value="USD">
          </div>
        </div>
      </span>
      <div class="row">
        <div class="three columns">
          <h4>Display Items</h4>
        </div>
        <div class="nine columns">
          <button class="button-primary" onclick="addOrderItem();">add</button>
        </div>
      </div>
      <span id="order_items"></span>
    </div>
  </div>

  <div class="section">
    <div class="container">
      <div class="row">
        <div class="twelve columns" id="options">
          <h4>Options</h4>
          <div class="options-request">
            <div class="doublebutton"><button class="button-primary">Name</button></div>
            <div class="doublebutton"><button class="button-primary">Phone</button></div>
            <div class="doublebutton"><button class="button-primary">Email</button></div>
            <div class="doublebutton"><button class="button-primary">Shipping</button></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="section">
    <div class="container">
      <div class="row">
        <div class="four columns">
          <h4>Shipping Options</h4>
        </div>
        <div class="three columns">
          <select id="shipping-type">
            <option value="shipping">shipping</option>
            <option value="delivery">delivery</option>
            <option value="pickup">pickup</option>
            <option value="invalid_type">invalid_type</option>
          </select>
        </div>
        <div class="five columns">
          <button class="button-primary" onclick="addShippingOption();">add</button>
        </div>
      </div>
      <span id="shipping-options"></span>
    </div>
  </div>
  <div class="section">
    <div class="container">
      <div class="row">
        <div class="twelve columns">
          <a class="button button-primary" id="paybutton" href="javascript:action()">pay</a>
        </div>
      </div>
      <div class="row">
        <div class="twelve columns">
          <h5>Result</h5>
          <pre><code id="result"></code></pre>
        </div>
      </div>
    </div>
  </div>


<script>
  var displayItemTemplate;
  var currentShippingOptionID = 0;

  function addOrderItem() {
    $("#order_items").append(displayItemTemplate);
  }

  function addShippingOption() {
    var element = $(`
      <div class="shipping-option" class="row">
        <div class="three columns">
            <input class="u-full-width shipping-option-id" type="text" placeholder="ID">
        </div>
        <div class="four columns">
            <input class="u-full-width shipping-option-label" type="text" placeholder="label">
        </div>
        <div class="three columns">
            <input class="u-full-width shipping-option-amount" type="number" placeholder="2.00" value="2.00">
        </div>
        <div class="doublebutton"><button class="button-primary" onclick="$(this).toggleClass('button-primary');">Selected</button></div>
      </div>
    `);
    element.find(".shipping-option-id").attr("value", ++currentShippingOptionID);
    element.find(".shipping-option-label").attr("value", "shipping-option-label-" + currentShippingOptionID);
    $("#shipping-options").append(element);
  }

  function removeThisItem(ev) {
    var obj = $(ev.parentNode.parentNode);
    obj.remove();
  }

  function action() {
    if (!window.PaymentRequest) {
     return;
    }

    // Supported payment methods
    var methods = [];
    $("#instruments div button.button-primary").each(function(idx) {
      methods.push($(this).text());
    });
    var supportedInstruments = [{ supportedMethods: methods }];

    // Checkout details
    var di = [];
    $("#order_items").children('#display-item').each(function(idx) {
      var v = $(this).find("#value").val();
      if (v === undefined) return;
      di.push({
          label: $(this).find("#label").val(),
          amount: { currency: $(this).find("#currency").val(), value: v}});
    });

    var shipping_options = [];
    $("#shipping-options").children(".shipping-option").each(function(idx) {
      var option_id = $(this).find(".shipping-option-id").val();
      var option_label = $(this).find(".shipping-option-label").val();
      var option_amount = $(this).find(".shipping-option-amount").val();
      var option_selected = $(this).find("button").hasClass("button-primary");

      shipping_options.push({
        id: option_id,
        label: option_label,
        amount: {
          currency: $("#currency").val(), value: option_amount
        },
        selected: option_selected
      })
    });

    var details = {
      displayItems: di,
      shippingOptions: shipping_options,
      total: {
        label: $("#total_item").find("#label").val(),
        amount: { currency: $("#total_item").find("#currency").val(),
                  value : $("#total_item").find("#value").val() }
      }
    };

    var shipping_type = document.getElementById("shipping-type");
    var options = {
      shippingType: shipping_type.options[shipping_type.selectedIndex].value
    };

    $("#options .options-request button.button-primary").each(function(idx) {
      var option_text = $(this).text();
      if (option_text == "Name")
        options.requestPayerName = true;
      if (option_text == "Phone")
        options.requestPayerPhone = true;
      if (option_text == "Email")
        options.requestPayerEmail = true;
      if (option_text == "Shipping")
        options.requestShipping = true;
    });

    // 1. Create a `PaymentRequest` instance
    var request = new PaymentRequest(supportedInstruments, details, options);

    // 2. Show the native UI with `.show()`
    request.show()
    // 3. Process the payment
    .then(result => {
      var data = {};
      data.methodName = result.methodName;
      data.details    = result.details;

      $("#result").text(JSON.stringify(data, null, 2));
      return result.complete('success');
    })
    .catch(() => {
    });
  };

$(() => {
  $("#instruments div button").click((ev) => {
    $(ev.target).toggleClass("button-primary");
  });

  $("#options div button").click((ev) => {
    $(ev.target).toggleClass("button-primary");
  });

  displayItemTemplate = document.getElementById("total_item")
      .innerHTML.replace('value="Total"', 'value="Item"');
});
</script>
</body>
</html>
